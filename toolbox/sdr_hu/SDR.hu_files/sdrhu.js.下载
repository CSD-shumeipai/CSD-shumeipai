var _____WB$wombat$assign$function_____ = function(name) {return (self._wb_wombat && self._wb_wombat.local_init && self._wb_wombat.local_init(name)) || self[name]; };
if (!self.__WB_pmw) { self.__WB_pmw = function(obj) { this.__WB_source = obj; return this; } }
{
  let window = _____WB$wombat$assign$function_____("window");
  let self = _____WB$wombat$assign$function_____("self");
  let document = _____WB$wombat$assign$function_____("document");
  let location = _____WB$wombat$assign$function_____("location");
  let top = _____WB$wombat$assign$function_____("top");
  let parent = _____WB$wombat$assign$function_____("parent");
  let frames = _____WB$wombat$assign$function_____("frames");
  let opener = _____WB$wombat$assign$function_____("opener");

//Copyright 2017 Andras Retzler 
//Reuse in any way is prohibited without written permission from the author

isPhone = (/Android|iPhone|iPad|iPod|BlackBerry|Windows Phone/i).test(navigator.userAgent || navigator.vendor || window.opera) 

function topimage_setup()
{
	if(!isPhone){
        $("#sdrhu-topimage-section").css("background-size",$("body").width()+50);
		skrollr.init({forceHeight: false});
	}
}

function setup_receiver_click()
{
	$(".sdrhu-receiver-panel").click(function(e) {
		if($(e.target).attr('class') == "sdrhu-vote")
		{
			var span_votenum = $(this).children(".sdrhu-vote").children("span.sdrhu-votenum")[0];
			$.get("/vote?id="+$(this).data("id"),function(x){
				if(x.indexOf("SUCCESS")!=-1) { $(span_votenum).text((parseInt($(span_votenum).text())+1).toString()); alert("Thanks for voting!"); }
				else if(x.indexOf("ERROR:ALREADY")!=-1) { alert("You have already voted for that receiver."); }
				else { alert("We've got the following error response: "+x); }
			});
		}
		else window.location.href=$(this).find("a")[0].href;
	});
}


function sdrhu_load_page()
{
	setup_receiver_click();
	$(".sdrhu-m-andris").attr("href",sendmail2("dmzpdme=epd$tg"));
	$(".sdrhu-m-legal").attr("href",sendmail2("xqsmx=epd$tg"));
	mkbands();
}

$(document).ready(sdrhu_load_page);

window.onload = function()
{
	if(typeof kittens != 'undefined') $("#sdrhu-apikey-regform").append($(("<input name=\"cats\" type=\"kitten\" value=\"".replace("kitt","hidd")) + rt(kittens,9) +"\"/>"))
	/*$(".sdrhu-receiver-panel").each(function(x) {
		$(this).css("transition-delay",Math.min(x*0.1,0.5).toString()+"s");
		$(this).css("transform","perspective( 1000px ) rotateX( 0deg )");
	});*/
};

window.onresize = function() { topimage_setup(); };

var rt = function (s,n) {return s.replace(/[a-zA-Z]/g,function(c){return String.fromCharCode((c<="Z"?90:122)>=(c=c.charCodeAt(0)+n)?c:c-26);});}
var irt = function (s,n) {return s.replace(/[a-zA-Z]/g,function(c){return String.fromCharCode((c>="a"?97:65)<=(c=c.charCodeAt(0)-n)?c:c+26);});}
var sendmail2 = function (s) { return "mailto:"+irt(s.replace("=",String.fromCharCode(0100)).replace("$","."),12); }


var bands = [
	{
		label:  "80m",
		start:	3500e3,
		end:	3900e3,
		bgcolor: "#678dff",
		fgcolor: "#fff"
	},
	{
		label:  "40m",
		start:	7000e3,
		end:	7200e3,
		bgcolor: "#67efff",
		fgcolor: "#000"
	},
	{
		label:  "30m",
		start:	10100e3,
		end:	10150e3,
		bgcolor: "#67ffe7",
		fgcolor: "#000"
	},
	{
		label:  "20m",
		start:	14000e3,
		end:	14350e3,
		bgcolor: "#67ff75",
		fgcolor: "#000"
	},
	{
		label:  "15m",
		start:	21000e3,
		end:	21450e3,
		bgcolor: "#78edbe",
		fgcolor: "#000"
	},
	{
		label:  "10m",
		start:	28000e3,
		end:	29690e3,
		bgcolor: "#c2ed78",
		fgcolor: "#000"
	},
	{
		label:  "2m",
		start:	144e6,
		end:	148e6,
		bgcolor: "#fff567",
		fgcolor: "#000"
	},
	{
		label:  "70cm",
		start:	430e6,
		end:	440e6,
		bgcolor: "#ffc167",
		fgcolor: "#000"
	},
];


function getband(start,end)
{
    if(start!=start || end!=end) return null;
	rx={
		start: start,
		end: end,
		bw: end-start
	};
	if(end<40e6 & rx.bw>10e6) {
		return {
			label:   "HF",
			fgcolor: "#fff",
			bgcolor: "#9a528f",
			start:   0,
			end:	 30e6
		};
	}

	band_found = false;

	bands.forEach(function(b){
		if(band_found) return;
		common_bw=0;
		if( rx.end < b.start || b.end < rx.start) common_bw=0;
		else {
			if (rx.start >= b.start && rx.end >= b.end) { common_bw = b.end - rx.start; }
			else if (rx.start <= b.start && rx.end <= b.end) { common_bw = rx.end - b.start;  }
			else if (rx.start >= b.start && rx.end <= b.end) { common_bw = rx.bw; }
			else if (rx.start <= b.start && rx.end >= b.end) { common_bw = b.end-b.start; }
		}
		if(common_bw>=10000) band_found = b;
		//console.log("common_bw: "+b.label+"  "+common_bw.toString());
		//console.log(b, rx);
		return false;
	});
	if(band_found) return band_found;
	//console.log(band_found, start,end);

	mhz2str=function(x){ return (Math.floor(x/1e5)/10).toString(); }

	if(rx.bw>1e6) return {
			label:  mhz2str(rx.start)+"MHz - "+mhz2str(rx.end)+"MHz",
			fgcolor: "#fff",
			bgcolor: "#999",
	};
	else return {
			label:  mhz2str((rx.start+rx.end)/2)+"MHz",
			fgcolor: "#fff",
			bgcolor: "#999",
	};
}

function mkbands()
{
	$(".sdrhu-bands").each( function() {
		that = $(this);
		$(this).data("bands").split(" ").forEach(function(x){
			params=x.split("-").map(function(x){return parseInt(x)});
			y=getband(params[0],params[1]);
            if(!y) return;
			//console.log(y);
			that.append ( $("<span /> ").attr({"class": "sdrhu-receiver-band"}).css( {"background-color": y.bgcolor, "color": y.fgcolor }).text(y.label) );
		});
		//

	} );
}

function clearsearch()
{
	window.location.href="/";
}


var map_last_infowindow = null;
var map_infowindow_contents=[];
var map;

function tmpl(template, obj)
{
	for(var propertyname in obj)
	{
		tlsearch="{"+propertyname+"}";
		while(template.indexOf(tlsearch)!=-1)
			template=template.replace(tlsearch,obj[propertyname]);
	}
	return template;
}

raund10 = +Math.round(Math.random()*4-2)/10;

function round10(x) { return Math.round(x*10)/10+raund10; }

function mkmap(data)
{
	console.log("all receivers listed:", data.receivers);
	/*
	map = new google.maps.Map(document.getElementById('sdrhu_map'), {
		center: {lat: -34.397, lng: 150.644},
		zoom: 8
	});

	*/
	$(window).load(function(){$("#sdrhu-footer-clear").remove();});
	$(window).resize(mapresize);
	mapresize();


    var bounds = new google.maps.LatLngBounds();
    var mapOptions = { mapTypeId: 'satellite' };

    // Display a map on the page
    map = new google.maps.Map(document.getElementById('sdrhu-map'), mapOptions);
    map.setTilt(45);

    // Multiple Markers
	last_gpscoords=null;
	gpccounter=0;
	var marker_index = 0;
	data.receivers.forEach(function(x) {
		gpscoords=x.gps.replace("(","").replace(")","").split(",").map(function(y){return parseFloat(y);});
		if(gpscoords[0]==0 && gpscoords[1]==0) return;
		if(gpscoords[0]==47 && gpscoords[1]==19) return; //skip those who didn't modify the default value in config_webrx.py
		if(!(gpscoords[0]<=90 && gpscoords[0]>=-90 && gpscoords[1]<180 && gpscoords[1]>-180)) { console.log("invalid GPS coordinates for this receiver:", x); return; }
		gpccounter++;
		gpscoords[0]=round10(gpscoords[0]);
		gpscoords[1]=round10(gpscoords[1]);
		new_infowindow_content=tmpl("<strong><a href=\"{url}\">{name}</a></strong> | {sdr_hw} <span class=\"sdrhu-bands sdrhu-map-bands\" data-bands=\"{bands}\"></span><br />",x);
		if(last_gpscoords && last_gpscoords[0]==gpscoords[0] && last_gpscoords[1]==gpscoords[1])
		{
			map_infowindow_contents[map_infowindow_contents.length-1]+=""+new_infowindow_content;
			return;
		}
		map_infowindow_contents.push(new_infowindow_content);
		var position = new google.maps.LatLng(gpscoords[0], gpscoords[1]);
        bounds.extend(position);
        marker = new google.maps.Marker({
            position: position,
            map: map,
            title:x.name
        });
		var infoWindow = new google.maps.InfoWindow();
		google.maps.event.addListener(marker, 'click', (function(marker, receiver, i) {
            return function() {
				if(map_last_infowindow) map_last_infowindow.close();
				map_last_infowindow = infoWindow;
				infoWindow.setContent(map_infowindow_contents[i]);
				infoWindow.open(map, marker);
				mkbands();
				//$(".sdrhu-map-infowindow-hidden").css("display","block");
            };
	        })(marker, x, marker_index));
		marker_index++;
		last_gpscoords=gpscoords;
	});

    // Info Window Content
    /*var infoWindowContent = [
        ['<div class="info_content">' +
        '<h3>London Eye</h3>' +
        '<p>The London Eye is a giant Ferris wheel situated on the banks of the River Thames. The entire structure is 135 metres (443 ft) tall and the wheel has a diameter of 120 metres (394 ft).</p>' +        '</div>'],
        ['<div class="info_content">' +
        '<h3>Palace of Westminster</h3>' +
        '<p>The Palace of Westminster is the meeting place of the House of Commons and the House of Lords, the two houses of the Parliament of the United Kingdom. Commonly known as the Houses of Parliament after its tenants.</p>' +
        '</div>']
    ];*/

    // Display multiple markers on a map
    /*

        // Allow each marker to have an info window
       */
	map.fitBounds(bounds);
	google.maps.event.addListenerOnce(map, 'idle', function() {
		/*var bounds = map.getBounds();
		console.log(bounds.j.N);
		console.log(bounds.j.j);
		if(bounds.j.N==180&&bounds.j.j==-180)
		{

			var lat = map.getCenter().lat();
			var lng = map.getCenter().lng();
			if(lng>0 && lng<180)
			{
				lng-=180;
				map.setCenter(new google.maps.LatLng(lat,lng));
			}
		}*/
		if($("body").width()>1900) return;
		var zoom=map.getZoom();
		if(zoom>1) map.setZoom(zoom-1);
	});

}

function initmap()
{
	$.getJSON("/ajax_map2", mkmap);
}

//from https://gist.github.com/kmaida/6045266
function convertTimestamp(timestamp) {
  var d = new Date(timestamp * 1000),	// Convert the passed timestamp to milliseconds
		yyyy = d.getFullYear(),
		mm = ('0' + (d.getMonth() + 1)).slice(-2),	// Months are zero based. Add leading 0.
		dd = ('0' + d.getDate()).slice(-2),			// Add leading 0.
		hh = d.getHours(),
		h = hh,
		min = ('0' + d.getMinutes()).slice(-2),		// Add leading 0.
		sec = ('0' + d.getSeconds()).slice(-2),		// Add leading 0.
		ampm = 'AM',
		time;
		//mm=["January","February","March","April","May","June","July","August","September","October","November","December"][d.getMonth()];

	/*
	if (hh > 12) {
		h = hh - 12;
		ampm = 'PM';
	} else if (hh === 12) {
		h = 12;
		ampm = 'PM';
	} else if (hh == 0) {
		h = 12;
	}
	*/
	// ie: 2013-02-18, 8:35 AM
	//time = dd + " " + mm + " " + yyyy + '. ' + h + ':' + min + ":" + sec; //+ ' ' + ampm;
	time = yyyy + "-" + mm + "-" + dd + ' ' + h + ':' + min + ":" + sec; //+ ' ' + ampm;
	return time;
}

function showBlogButton()
{
	return;
	obj=$("#sdrhu-main-yellow-btn");
	$(document).ready(function() {
		window.setTimeout( function() {
		obj.animate( {
			opacity: 1,
			left: 0
		}, 700, function()
		{
			window.setTimeout(function() { obj.animate( {opacity:0}, 200,
				function() {
					obj.css("background-color", "#fff");
					obj.css("color", "#808080");
					obj.css("border-color", "#cccccc");
					obj.animate( {opacity: 1}, 200 );
				}
			); }, 3000);
		} );
	}, 500);

	});
}

function receiverPanelOnload(i,j)
{
	window.setTimeout(function(){
	panel=$("#sdrhu_receiver_panel_"+i.toString());
	panel.css("transform","perspective( 1000px ) rotateX( 0deg )");
},(isPhone)?0 : 20+Math.min(j*30,250));
}



}
/*
     FILE ARCHIVED ON 00:49:18 Jan 04, 2020 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 18:36:35 Dec 29, 2020.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
*/
/*
playback timings (ms):
  RedisCDXSource: 0.745
  esindex: 0.015
  PetaboxLoader3.resolve: 58.162 (2)
  exclusion.robots.policy: 0.216
  exclusion.robots: 0.232
  load_resource: 193.701 (2)
  LoadShardBlock: 61.636 (3)
  CDXLines.iter: 22.907 (3)
  PetaboxLoader3.datanode: 140.552 (5)
  captures_list: 91.916
*/